# Getting Started Guide
Welcome to the beginners guide of `gcdt`. In this guide we will cover what `gcdt` is and how to use it to
create beautiful infrastructure as code (IaC) with `kumo`, use it to deploying and configuring you AWS Lambda with `ramuda`,
deploy your application with Codedeploy scripts and `tenkai`, and do all of this things for different Environment (dev, stage, prod)
## Infrastructure as code
Infrastructure as Code (IaC) is a type of IT infrastructure that operations teams can automatically manage and provision through code, rather than using a manual process. Defining your infrastructure as code you will solve a lot of problems because code is:
- portable
- reusable
- shareable
- testable.
## Installation
### Install Python
First of all you need to have Python installed. Python should be 2.7 or higher
**On MacOS try to use preinstalled Python**

### Install pip and virtualenv
#### MacOS
```bash
$ sudo easy_install pip
$ sudo pip install pip --upgrade # to have the latest version of pip
$ sudo pip install virtualenv
```
### Install gcdt and gcdt plugins
#### Install gcdt
First of all you need to create virtualenv and activate it. It's pretty easy.
```bash
$ virtualenv venv
$ source ./venv/bin/activate
```
gcdt needs some gcdt-glugins so you should want to install these together. Plugins is a powerful tool to add features to `gcdt` without having to directly modify the `gcdt` core. The easiest way is to put the dependencies into a requirements_gcdt.txt file:
```bash
gcdt
gcdt-say-hello
gcdt-config-reader
gcdt-lookups
gcdt-bundler
gcdt-slack-integration
gcdt-datadog-integration
gcdt-gen-serverless
```
then
```bash
$ pip install -r requirements_gcdt.txt
```
To check that everything is good and `gcdt` installed just do:
```bash
$ gcdt version
gcdt version 0.1.403
gcdt plugins:
 * gcdt-config-reader version 0.0.17
 * gcdt-say-hello version 0.0.14
 * glomex-config-reader version 0.0.18
 * gcdt-slack-integration version 0.0.14
 * gcdt-datadog-integration version 0.0.15
 * gcdt-lookups version 0.0.17
```

## Kumo
Kumo is a tool which help you to manage and deploy your infrastructure using Cloudformation templates which generated by [troposphere](https://github.com/cloudtools/troposphere). With kumo you can easily create infrastructure for different Environments(dev, stage, prod).

### Create your first stack with kumo
First of all you need to create two files:
* *cloudformation.py* - here you will describe you infrastructure using `troposphere`
* *gcdt_(dev|stage|prod)* - settings for your ENV in [hocon](https://github.com/typesafehub/config/blob/master/HOCON.md) format, needs to include all parameters for the cloudformation template + stack name. You should have separate config for each ENV.

Let's create simple `gcdts_dev.conf`*(please change all values according your AWS account)*:
```bash
{
  "kumo": {
    "StackName": "gcdt-sample-stack",
    "VPCId": "lookup:stack:<stack-name>:DefaultVPCId",
    "ScaleMinCapacity": "1",
    "ScaleMaxCapacity": "1",
    "InstanceType": "t2.micro",
    "DefaultInstancePolicyARN": "lookup:stack:<stack-name>:DefaultInstancePolicyARN",
    "AMI": "lookup:baseami"
  }
}
```
In `VPCId` and `DefaultInstancePolicyARN` used `gcdt-lookups` plugin which will search outputs in CloudFormation stack, that you mention in config file above, values for `DefaultVPCId` and `DefaultInstancePolicyARN` and use it in your template. *Instead of `<stack-name>` you should provide your stack name or use hardcoded value(not recommended).*
It's time to create our first Infrastructure as Code. Let's to this.
Here is simple [cloudformation.py](https://github.com/glomex/gcdt-sample-stack/blob/master/infrastructure/cloudformation.py) script. Use it to as a template for creating your infrastructure.

### Deploy stack to AWS
Before running deployment we need to set some necessary ENV variables. **Remember**: You need this ENV variables exported each time before running any `gcdt` command.
```bash
$ export ENV=dev
$ export AWS_DEFAULT_PROFILE=glomex # Default profile. Generated by aws-mfa
$ export AWS_DEFAULT_REGION=eu-west-1
```
Run your first infrastructure deployment. It's really easy.
```bash
$ kumo deploy
```
![Kumo deploy output](_static/gifs/kumo_deploy_output.gif "Kumo_Deploy_Output")
**More information about `kumo` you can find in [docs](http://gcdt.readthedocs.io/en/latest/20_kumo.html)**

## Ramuda
Ramuda will help you to deploy, manage and control AWS Lambda. Ramuda support such runtimes: **nodejs4.3, nodejs6.10, python2.7, python3.6**
### Deploy simple AWS Lambda
Create `gcdt_(dev|stage|prod)` file or update if you create it with `kumo` *(please change all values according your AWS account)*:
```bash
"ramuda": {
  "bundling": {
    "folders": [
        {
            "source": "./node_modules",
            "target": "./node_modules"
        }
    ],
    "zip": "bundle.zip"
  },
  "lambda": {
    "name" = "jenkins-gcdt-lifecycle-for-ramuda",
    "description" = "lambda test for ramuda",
    "role" = "lookup:stack:<stack-name>:LambdaArnForDeploy",
    "handlerFunction" = "handler.handle",
    "handlerFile" = "handler.py",
    "timeout" = "300",
    "memorySize" = "256",
    "vpc": {
            "subnetIds": [
                "lookup:stack:pnb-dev:LambdaSubnetIda",
                "lookup:stack:pnb-dev:LambdaSubnetIdb",
                "lookup:stack:pnb-dev:LambdaSubnetIdc"
            ],
        }
  }
}
```
then do:
```bash
$ ramuda deploy
```
**More information about `ramuda` you can find in [docs](http://gcdt.readthedocs.io/en/latest/40_ramuda.html)**

## Tenkai
tenkai will help you to deploy your application using AWS [Codedeploy](https://aws.amazon.com/codedeploy/).
tenkai will create bundle and upload it to s3 with all files that you have in `codedeploy` folder. Create `codedeploy_(dev|stage|prod)` file *(please change all values according your AWS account)*:
```bash
codedeploy {
  applicationName = "lookup:stack:<stack-name>:applicationName",
  deploymentGroupName = "lookup:stack:<stack-name>:DeploymentGroup",
  deploymentConfigName = "lookup:stack:<stack-name>:DeploymentConfig"
  artifactsBucket = "7finity-infra-dev-deployment"
}
```
**More information about `tenkai` you can find in [docs](http://gcdt.readthedocs.io/en/latest/30_tenkai.html)**

## Yugen
yugen is a tool that will help you to deploy and manage your API with AWS API Gateway. All you need is top put your `swagger.yml` into the same folder as a `gcdt_(dev|stage|prod)` file. Also, add some new configs into it *(please change all values according your AWS account)*:
```bash
"yugen": {
    "api": {
        "apiKey": "xxxxxxxxxxxxxx",
        "description": "Gcdt sample API based on dp api-mock",
        "name": "jenkins-gcdt-sample-api-dev",
        "targetStage": "mock"
    }
}
```
**More information about `yugen` you can find in [docs](http://gcdt.readthedocs.io/en/latest/50_yugen.html)**
